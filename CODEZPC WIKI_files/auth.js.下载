(function(){"use strict";let loginDialog;let closeDialog;let loginForm;let errorMessage;let loginUsernameInput;let editCallback=null;document.addEventListener("DOMContentLoaded",function(){loginDialog=document.querySelector(".login-dialog");closeDialog=document.querySelector(".login-dialog .close-dialog");loginForm=document.getElementById("loginForm");errorMessage=document.querySelector(".login-dialog .error-message");loginUsernameInput=document.getElementById("username");if(closeDialog){closeDialog.addEventListener("click",hideLoginDialog)}if(loginForm){loginForm.addEventListener("submit",handleLoginSubmit)}const loginButton=document.querySelector(".toolbar-button.auth-button.primary");if(loginButton){loginButton.addEventListener("click",function(){loginDialog.classList.add("active");loginForm.reset();errorMessage.style.display="none";setTimeout(()=>{loginUsernameInput.focus()},100);window.loginCallback=function(){updateToolbarButtons()}})}const logoutButton=document.querySelector(".logout-button");if(logoutButton){logoutButton.addEventListener("click",handleLogout)}document.addEventListener("click",function(e){if(e.target.closest(".login-dialog .close-dialog")){hideLoginDialog()}});checkDefaultPassword();checkPendingActions()});function showLoginDialog(callback){loginDialog.classList.add("active");editCallback=callback;errorMessage.style.display="none";loginForm.reset();setTimeout(()=>{loginUsernameInput.focus()},100)}function hideLoginDialog(){if(loginDialog){loginDialog.classList.remove("active")}}async function handleLoginSubmit(e){e.preventDefault();const username=document.getElementById("username").value;const password=document.getElementById("password").value;const keepLoggedIn=document.getElementById("keepLoggedIn")?.checked||false;try{const response=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,password:password,keepLoggedIn:keepLoggedIn})});if(response.ok){hideLoginDialog();if(window.loginCallback){localStorage.setItem("pendingAction","loginCallback");window.loginCallback=null}else if(editCallback){localStorage.setItem("pendingAction","editPage")}window.location.reload()}else{let msg=window.i18n?window.i18n.t("login.error"):"Invalid username or password";if(response.status===429){try{const data=await response.json();if(data&&data.message){msg=data.message;if(data.retryAfter){const retryTxt=window.i18n?window.i18n.t("login.retry_in"):"retry in";msg+=` (${retryTxt} ${data.retryAfter}s)`}}}catch(e){}}errorMessage.textContent=msg;errorMessage.style.display="block"}}catch(error){console.error("Login error:",error);errorMessage.textContent="An error occurred. Please try again.";errorMessage.style.display="block"}}async function handleLogout(){try{const response=await fetch("/api/logout",{method:"POST"});if(response.ok){updateToolbarButtons();window.location.reload()}else{window.DialogSystem.showMessageDialog("Error","Failed to logout")}}catch(error){console.error("Error during logout:",error);window.DialogSystem.showMessageDialog("Error","Failed to logout")}}async function checkIfUserIsAdmin(){try{const response=await fetch("/api/check-auth");if(!response.ok){return false}const data=await response.json();return data.role==="admin"}catch(error){console.error("Error checking admin status:",error);return false}}async function checkUserRole(requiredRole){try{const response=await fetch("/api/check-auth");if(!response.ok){return false}const data=await response.json();if(requiredRole==="admin"){return data.role==="admin"}else if(requiredRole==="editor"){return data.role==="admin"||data.role==="editor"}else if(requiredRole==="viewer"){return data.role==="admin"||data.role==="editor"||data.role==="viewer"}return false}catch(error){console.error("Error checking user role:",error);return false}}function showPermissionError(requiredRole){let message="You don't have permission to perform this action.";if(requiredRole){message=`This feature requires ${requiredRole} privileges.`}window.DialogSystem.showMessageDialog("Permission Denied",message)}function showAdminOnlyError(){window.DialogSystem.showMessageDialog("Admin Access Required","This feature is only available to administrators.")}async function updateToolbarButtons(){try{const authResponse=await fetch("/api/check-auth");if(authResponse.status===401){document.querySelectorAll(".admin-only-button").forEach(btn=>{btn.style.display="none"});document.querySelector(".toolbar-button.auth-button.primary").style.cssText="display: inline-flex !important";document.querySelector(".logout-button").style.cssText="display: none !important";return}const authData=await authResponse.json();const isAdmin=authData.role==="admin";const isEditor=authData.role==="editor";if(isAdmin){document.querySelectorAll(".admin-only-button").forEach(btn=>{btn.style.cssText="display: inline-flex !important"});document.querySelectorAll(".editor-only-button").forEach(btn=>{btn.style.cssText="display: inline-flex !important"});const renameBtn=document.querySelector(".move-document");if(renameBtn&&(window.location.pathname==="/"||window.location.pathname==="/homepage")){renameBtn.style.cssText="display: none !important"}}else if(isEditor){document.querySelectorAll(".admin-only-button").forEach(btn=>{btn.style.display="none"});document.querySelectorAll(".editor-only-button").forEach(btn=>{btn.style.cssText="display: inline-flex !important"});const renameBtn=document.querySelector(".move-document");if(renameBtn&&(window.location.pathname==="/"||window.location.pathname==="/homepage")){renameBtn.style.cssText="display: none !important"}}else{document.querySelectorAll(".admin-only-button, .editor-only-button").forEach(btn=>{btn.style.display="none"})}document.querySelector(".toolbar-button.auth-button.primary").style.cssText="display: none !important";document.querySelector(".logout-button").style.cssText="display: inline-flex !important"}catch(error){console.error("Error checking authentication status:",error)}}async function checkDefaultPassword(){try{const response=await fetch("/api/check-default-password");const data=await response.json();const banner=document.getElementById("password-warning-banner");if(!banner)return;if(data.defaultPasswordInUse){banner.style.display="block";document.body.classList.add("has-password-warning")}else{banner.style.display="none";document.body.classList.remove("has-password-warning")}}catch(error){console.error("Error checking default password:",error)}}function checkPendingActions(){const pendingAction=localStorage.getItem("pendingAction");if(pendingAction){localStorage.removeItem("pendingAction");if(pendingAction==="editPage"){checkUserRole("editor").then(canEdit=>{if(canEdit){const url=new URL(window.location);url.searchParams.set("mode","edit");window.location.href=url.toString()}else{showPermissionError("editor")}})}else if(pendingAction==="loginCallback"){updateToolbarButtons()}}}window.Auth={showLoginDialog:showLoginDialog,hideLoginDialog:hideLoginDialog,checkIfUserIsAdmin:checkIfUserIsAdmin,checkUserRole:checkUserRole,showAdminOnlyError:showAdminOnlyError,showPermissionError:showPermissionError,updateToolbarButtons:updateToolbarButtons,checkDefaultPassword:checkDefaultPassword}})();