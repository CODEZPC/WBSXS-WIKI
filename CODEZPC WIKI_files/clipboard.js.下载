function initClipboardHandling(){console.log("Initializing clipboard handler");document.addEventListener("paste",documentPasteHandler);if(window.WikiConfig&&window.WikiConfig.enableLinkEmbedding){setupDirectTextareaBinding()}else{console.log("Link embedding from clipboard is disabled")}}function setupDirectTextareaBinding(){bindToExistingCodeMirrors();const observer=new MutationObserver(mutations=>{for(const mutation of mutations){if(mutation.addedNodes.length){bindToExistingCodeMirrors();break}}});observer.observe(document.body,{childList:true,subtree:true});setTimeout(bindToExistingCodeMirrors,1e3);setTimeout(bindToExistingCodeMirrors,2e3)}function bindToExistingCodeMirrors(){const textareas=document.querySelectorAll(".CodeMirror textarea");if(textareas.length===0){return}textareas.forEach(textarea=>{if(!textarea.hasAttribute("data-url-paste-bound")){textarea.addEventListener("paste",handleUrlPaste,true);textarea.setAttribute("data-url-paste-bound","true");console.log("URL paste handler bound to CodeMirror textarea")}})}function handleUrlPaste(event){const cmElement=event.target.closest(".CodeMirror");if(!cmElement||!cmElement.CodeMirror){return}const editor=cmElement.CodeMirror;if(!editor.somethingSelected()){return}const clipboardText=event.clipboardData.getData("text/plain").trim();if(!clipboardText){return}const looksLikeUrl=clipboardText.includes("//")||clipboardText.includes("www.")||clipboardText.includes(".")||clipboardText.includes(":");if(looksLikeUrl){event.preventDefault();event.stopPropagation();const selectedText=editor.getSelection();const isMultiLine=selectedText.includes("\n");if(isMultiLine){editor.replaceSelection(clipboardText);console.log("Replaced multiline selection with URL")}else{let url=clipboardText;if(!url.startsWith("http://")&&!url.startsWith("https://")){url="http://"+url}const markdownLink=`[${selectedText}](${url})`;editor.replaceSelection(markdownLink);console.log("Created link:",markdownLink)}}}async function documentPasteHandler(event){if(!window.WikiEditor||!window.WikiEditor.isEditorActive()){return}const target=event.target;const isInEditor=target.classList.contains("CodeMirror")||target.closest(".CodeMirror")!==null;if(!isInEditor){return}await handleImagePaste(event)}async function handleImagePaste(event){if(!event.clipboardData||!event.clipboardData.items){return}const cmElement=document.querySelector(".CodeMirror");if(!cmElement||!cmElement.CodeMirror){return}const editor=cmElement.CodeMirror;const items=event.clipboardData.items;let imageFile=null;for(let i=0;i<items.length;i++){if(items[i].type.startsWith("image/")){imageFile=items[i].getAsFile();break}}if(!imageFile){return}event.preventDefault();try{const docPath=getCurrentDocPath();const timestamp=(new Date).toISOString().replace(/[:.]/g,"-");const extension=imageFile.type.split("/")[1]||"png";const filename=`image-${timestamp}.${extension}`;const formData=new FormData;formData.append("file",imageFile,filename);formData.append("docPath",docPath);const loadingPlaceholder=`![Uploading ${filename}...]()`;const cursor=editor.getCursor();editor.replaceRange(loadingPlaceholder,cursor);const response=await fetch("/api/files/upload",{method:"POST",body:formData});const data=await response.json();const text=editor.getValue();const placeholderPos=text.indexOf(loadingPlaceholder);if(data.success){const imageMarkdown=`![](${filename})`;if(placeholderPos>=0){const placeholderStart=editor.posFromIndex(placeholderPos);const placeholderEnd=editor.posFromIndex(placeholderPos+loadingPlaceholder.length);editor.replaceRange(imageMarkdown,placeholderStart,placeholderEnd)}else{editor.replaceSelection(imageMarkdown)}console.log("Image uploaded successfully:",filename)}else{const errorMessage=`<!-- Failed to upload image: ${data.message||"Unknown error"} -->`;if(placeholderPos>=0){const placeholderStart=editor.posFromIndex(placeholderPos);const placeholderEnd=editor.posFromIndex(placeholderPos+loadingPlaceholder.length);editor.replaceRange(errorMessage,placeholderStart,placeholderEnd)}else{editor.replaceSelection(errorMessage)}console.error("Failed to upload image:",data.message)}}catch(error){console.error("Error handling clipboard paste:",error);try{const cmElement=document.querySelector(".CodeMirror");if(cmElement&&cmElement.CodeMirror){cmElement.CodeMirror.replaceSelection(`<!-- Error uploading pasted image: ${error.message} -->`)}}catch(e){console.error("Could not insert error message into editor:",e)}}}document.addEventListener("DOMContentLoaded",initClipboardHandling);window.ClipboardHandler={init:initClipboardHandling,handleUrlPaste:handleUrlPaste,handleImagePaste:handleImagePaste};