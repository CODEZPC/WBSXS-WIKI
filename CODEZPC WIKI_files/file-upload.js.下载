function showFileUploadDialog(){const fileUploadDialog=document.querySelector(".file-upload-dialog");const fileUploadErrorMessage=fileUploadDialog.querySelector(".error-message");const fileUploadForm=document.getElementById("fileUploadForm");fileUploadDialog.classList.add("active");fileUploadErrorMessage.style.display="none";fileUploadForm.reset();window.SettingsManager.fetchMaxUploadSize().then(()=>{const isFileUploadCheckingDisabled=window.SettingsManager.isFileUploadCheckingDisabled();const allowedTypesHelp=fileUploadDialog.querySelector(".allowed-types-help");const unrestrictedTypesHelp=fileUploadDialog.querySelector(".unrestricted-types-help");if(isFileUploadCheckingDisabled){if(allowedTypesHelp)allowedTypesHelp.style.display="none";if(unrestrictedTypesHelp)unrestrictedTypesHelp.style.display="block"}else{if(allowedTypesHelp)allowedTypesHelp.style.display="block";if(unrestrictedTypesHelp)unrestrictedTypesHelp.style.display="none"}});setTimeout(()=>{const firstTabButton=document.querySelector('.file-upload-tabs .tab-button[data-tab="upload-tab"]');const firstTabPane=document.getElementById("upload-tab");if(firstTabButton&&firstTabPane){document.querySelectorAll(".file-upload-tabs .tab-button").forEach(btn=>{btn.classList.remove("active")});document.querySelectorAll(".file-upload-dialog .tab-pane").forEach(pane=>{pane.classList.remove("active")});firstTabButton.classList.add("active");firstTabPane.classList.add("active")}},50);if(document.getElementById("files-tab").classList.contains("active")){window.FileUtilities.loadDocumentFiles()}}function hideFileUploadDialog(){const fileUploadDialog=document.querySelector(".file-upload-dialog");fileUploadDialog.classList.remove("active")}async function handleFileUpload(e){e.preventDefault();const fileUploadForm=document.getElementById("fileUploadForm");const fileUploadErrorMessage=document.querySelector(".file-upload-dialog .error-message");await window.SettingsManager.fetchMaxUploadSize();const fileInput=document.getElementById("fileToUpload");const file=fileInput.files[0];if(!file){let message="Please select a file to upload";if(window.i18n&&window.i18n.t){message=window.i18n.t("attachments.no_file_chosen")}fileUploadErrorMessage.textContent=message;fileUploadErrorMessage.style.display="block";return}const maxFileUploadSizeMB=window.SettingsManager.maxFileUploadSizeMB();const maxFileUploadSizeBytes=window.SettingsManager.maxFileUploadSizeBytes();if(file.size>maxFileUploadSizeBytes){let message=`File size exceeds the ${maxFileUploadSizeMB}MB limit`;if(window.i18n&&window.i18n.t){message=window.i18n.t("attachments.error_file_size").replace("{{maxFileSize}}",`${maxFileUploadSizeMB}MB`)}fileUploadErrorMessage.textContent=message;fileUploadErrorMessage.style.display="block";return}const ext=file.name.split(".").pop().toLowerCase();const isFileUploadCheckingDisabled=window.SettingsManager.isFileUploadCheckingDisabled();if(!isFileUploadCheckingDisabled&&!ALLOWED_FILE_EXTENSIONS.includes(ext)){console.log("[DEBUG] - Showing error for invalid file type");let allowedTypesDisplay;try{let extensionsArray=ALLOWED_FILE_EXTENSIONS;if(typeof ALLOWED_FILE_EXTENSIONS==="string"&&ALLOWED_FILE_EXTENSIONS.startsWith("[")&&ALLOWED_FILE_EXTENSIONS.endsWith("]")){extensionsArray=JSON.parse(ALLOWED_FILE_EXTENSIONS)}if(Array.isArray(extensionsArray)){allowedTypesDisplay=extensionsArray.join(", ")}else{allowedTypesDisplay=String(ALLOWED_FILE_EXTENSIONS).replace(/[\[\]"]/g,"").replace(/,/g,", ")}}catch(e){allowedTypesDisplay=String(ALLOWED_FILE_EXTENSIONS).replace(/[\[\]"]/g,"").replace(/,/g,", ")}let message="Invalid file type. Allowed types: "+allowedTypesDisplay;if(window.i18n&&window.i18n.t){message=window.i18n.t("attachments.error_file_type").replace("{{allowedTypes}}",allowedTypesDisplay)}fileUploadErrorMessage.textContent=message;fileUploadErrorMessage.style.display="block";return}const formData=new FormData;formData.append("file",file);formData.append("docPath",getCurrentDocPath());try{const uploadBtn=document.getElementById("uploadFileBtn");const originalText=uploadBtn.textContent;uploadBtn.textContent="Uploading...";uploadBtn.disabled=true;const response=await fetch("/api/files/upload",{method:"POST",body:formData});uploadBtn.textContent=originalText;uploadBtn.disabled=false;const data=await response.json();if(!data.success){throw new Error(data.message||"Failed to upload file")}fileUploadForm.reset();const filesTabBtn=Array.from(document.querySelectorAll(".file-upload-tabs .tab-button")).find(btn=>btn.getAttribute("data-tab")==="files-tab");if(filesTabBtn){filesTabBtn.click()}window.FileUtilities.loadDocumentFiles()}catch(error){console.error("Error uploading file:",error);fileUploadErrorMessage.textContent=error.message||"Failed to upload file";fileUploadErrorMessage.style.display="block"}}async function loadAndHighlightFilesTab(){const docPath=getCurrentDocPath();const response=await fetch(`/api/files/list/${docPath}`);const data=await response.json();const files=data.files||[];let markdown="";if(typeof editor!=="undefined"&&editor&&editor.getValue){markdown=editor.getValue();console.log("Got markdown from global editor variable")}else{const codeMirrorElement=document.querySelector(".CodeMirror");if(codeMirrorElement&&codeMirrorElement.CodeMirror){markdown=codeMirrorElement.CodeMirror.getValue();console.log("Got markdown from CodeMirror DOM instance")}else{const textareas=document.querySelectorAll("textarea");for(const textarea of textareas){if(textarea.value&&textarea.value.length>0){markdown=textarea.value;console.log("Got markdown from textarea");break}}}}if(!markdown){console.warn("Could not find editor content")}console.log("Extracted markdown length:",markdown.length);console.log("Markdown sample:",markdown.substring(0,300));const mentionedFiles=window.FileUtilities.extractMentionedFilenamesFromMarkdown(markdown);console.log("Mentioned files found:",mentionedFiles);window.FileUtilities.renderFilesList(files,mentionedFiles)}function initFileUpload(){const uploadFileButton=document.querySelector(".upload-file");const fileUploadDialog=document.querySelector(".file-upload-dialog");if(!fileUploadDialog)return;const closeFileUploadDialog=fileUploadDialog.querySelector(".close-dialog");const fileUploadForm=document.getElementById("fileUploadForm");const fileUploadTabButtons=document.querySelectorAll(".file-upload-tabs .tab-button");const fileUploadTabPanes=fileUploadDialog.querySelectorAll(".tab-pane");const fileInput=document.getElementById("fileToUpload");const fileUploadErrorMessage=fileUploadDialog.querySelector(".error-message");if(uploadFileButton){uploadFileButton.addEventListener("click",showFileUploadDialog)}if(closeFileUploadDialog){closeFileUploadDialog.addEventListener("click",hideFileUploadDialog)}fileUploadTabButtons.forEach(button=>{button.addEventListener("click",function(){const tabId=this.getAttribute("data-tab");fileUploadTabButtons.forEach(btn=>btn.classList.remove("active"));fileUploadTabPanes.forEach(pane=>pane.classList.remove("active"));this.classList.add("active");document.getElementById(tabId).classList.add("active");if(tabId==="files-tab"){loadAndHighlightFilesTab()}})});if(fileUploadForm){fileUploadForm.addEventListener("submit",handleFileUpload);if(fileInput){fileInput.addEventListener("change",function(){if(fileUploadErrorMessage){fileUploadErrorMessage.style.display="none"}})}}const fileAttachmentsSection=document.querySelector(".file-attachments-section");if(fileAttachmentsSection&&document.querySelector(".markdown-content")){window.FileUtilities.loadDocumentFiles()}}window.FileUpload={init:initFileUpload,showFileUploadDialog:showFileUploadDialog,hideFileUploadDialog:hideFileUploadDialog};document.addEventListener("DOMContentLoaded",initFileUpload);