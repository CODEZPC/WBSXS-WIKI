function formatFileSize(bytes){if(bytes===undefined||bytes===null){return"Unknown size"}if(bytes<1024){return bytes+" B"}else if(bytes<1024*1024){return(bytes/1024).toFixed(1)+" KB"}else{return(bytes/(1024*1024)).toFixed(1)+" MB"}}function getFileIcon(fileType){let icon="";if(!fileType){return'<i class="fa fa-file-o"></i>'}if(fileType.startsWith("image/")){icon='<i class="fa fa-file-image-o"></i>'}else if(fileType==="application/pdf"){icon='<i class="fa fa-file-pdf-o"></i>'}else if(fileType==="application/zip"){icon='<i class="fa fa-file-archive-o"></i>'}else if(fileType==="text/plain"){icon='<i class="fa fa-file-text-o"></i>'}else if(fileType==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"){icon='<i class="fa fa-file-word-o"></i>'}else if(fileType==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"){icon='<i class="fa fa-file-excel-o"></i>'}else if(fileType==="application/vnd.openxmlformats-officedocument.presentationml.presentation"){icon='<i class="fa fa-file-powerpoint-o"></i>'}else if(fileType==="video/mp4"||fileType==="video/quicktime"||fileType==="video/webm"||fileType==="video/avi"){icon='<i class="fa fa-file-video-o"></i>'}else{icon='<i class="fa fa-file-o"></i>'}return icon}function renderFilesList(files,mentionedFiles){const filesList=document.querySelector(".files-list");if(!filesList){console.error("Files list element not found");return}let mentionedSet=null;if(Array.isArray(mentionedFiles)){mentionedSet=new Set(mentionedFiles.map(f=>f.toLowerCase()));console.log("Mentioned files set:",mentionedSet)}console.log("Rendering files list:",files);if(!files||files.length===0){filesList.innerHTML='<div class="empty-message">'+(window.i18n?window.i18n.t("attachments.no_files"):"No files found for this document.")+"</div>";return}const errorMessage=document.querySelector(".error-message");if(errorMessage&&errorMessage.style.display==="block"){errorMessage.style.display="none"}const html=files.map(file=>{console.log("Processing file:",file);let safeFile;if(typeof file==="string"){const filename=file;const fileExt=filename.split(".").pop().toLowerCase();let fileType=FILE_EXTENSION_MIME_TYPES[fileExt]||"";safeFile={URL:`/api/files/${getCurrentDocPath()}/${filename}`,Type:fileType,Name:filename,Size:0}}else{safeFile={URL:file.URL||`/api/files/${getCurrentDocPath()}/${file.Name||file.name||"unknown"}`,Type:file.Type||file.type||"",Name:file.Name||file.name||"Unknown file",Size:file.Size||file.size||0}}console.log("Safe file object:",safeFile);const docPath=getCurrentDocPath();const filename=safeFile.Name;const filePath=`${docPath}/${filename}`;console.log("File operation path:",filePath);const isImage=safeFile.Type&&safeFile.Type.startsWith("image/");let highlightClass="";if(mentionedSet&&mentionedSet.has(filename.toLowerCase())){highlightClass=" mentioned-in-doc";console.log("File is mentioned:",filename)}return`
            <div class="file-item${highlightClass}" data-file-url="${safeFile.URL}">
                <div class="file-info">
                    <div class="file-icon">${getFileIcon(safeFile.Type)}</div>
                    <div class="file-name" data-path="${filePath}" data-current-name="${safeFile.Name}">
                        <span class="name-text">${safeFile.Name}</span>
                        <input type="text" class="name-edit" value="${safeFile.Name}" style="display: none;">
                    </div>
                    <div class="file-size">${formatFileSize(safeFile.Size)}</div>
                </div>
                <div class="file-actions">
                    <button class="insert-file-btn" title="${window.i18n?window.i18n.t("common.insert"):"Insert into editor"}" data-url="${safeFile.URL}" data-is-image="${isImage}" data-name="${safeFile.Name}" data-i18n-title="common.insert">
                        <i class="fa fa-plus"></i>
                        <span data-i18n="common.insert">${window.i18n?window.i18n.t("common.insert"):"Insert"}</span>
                    </button>
                    <button class="view-file-btn" title="${window.i18n?window.i18n.t("common.view"):"View file"}" data-url="${safeFile.URL}" data-i18n-title="common.view">
                        <i class="fa fa-eye"></i>
                        <span data-i18n="common.view">${window.i18n?window.i18n.t("common.view"):"View"}</span>
                    </button>
                    <button class="rename-file-btn" title="${window.i18n?window.i18n.t("common.rename"):"Rename file"}" data-path="${filePath}" data-name="${safeFile.Name}" data-i18n-title="common.rename">
                        <i class="fa fa-pencil"></i>
                        <span data-i18n="common.rename">${window.i18n?window.i18n.t("common.rename"):"Rename"}</span>
                    </button>
                    <button class="delete-file-btn" title="${window.i18n?window.i18n.t("common.delete"):"Delete file"}" data-path="${filePath}" data-i18n-title="common.delete">
                        <i class="fa fa-trash"></i>
                        <span data-i18n="common.delete">${window.i18n?window.i18n.t("common.delete"):"Delete"}</span>
                    </button>
                </div>
            </div>
        `}).join("");filesList.innerHTML=html;filesList.querySelectorAll(".delete-file-btn").forEach(button=>{button.addEventListener("click",()=>{const path=button.getAttribute("data-path");deleteFile(path)})});filesList.querySelectorAll(".rename-file-btn").forEach(button=>{button.addEventListener("click",e=>{e.stopPropagation();const fileNameElement=button.closest(".file-item").querySelector(".file-name");const nameText=fileNameElement.querySelector(".name-text");const nameEdit=fileNameElement.querySelector(".name-edit");const fullName=fileNameElement.getAttribute("data-current-name");const lastDotIndex=fullName.lastIndexOf(".");const hasExtension=lastDotIndex>0;const nameWithoutExt=hasExtension?fullName.substring(0,lastDotIndex):fullName;const extension=hasExtension?fullName.substring(lastDotIndex):"";nameText.style.display="none";nameEdit.style.display="block";nameEdit.focus();if(hasExtension){nameEdit.setSelectionRange(0,nameWithoutExt.length)}else{nameEdit.select()}})});filesList.querySelectorAll(".name-edit").forEach(input=>{input.addEventListener("keydown",async e=>{if(e.key==="Enter"){e.preventDefault();const newName=input.value.trim();const fileNameElement=input.closest(".file-name");const path=fileNameElement.getAttribute("data-path");const currentName=fileNameElement.getAttribute("data-current-name");const lastDotIndex=currentName.lastIndexOf(".");const hasExtension=lastDotIndex>0;const extension=hasExtension?currentName.substring(lastDotIndex):"";let finalNewName=newName;if(hasExtension&&!newName.includes(".")){finalNewName=newName+extension}if(finalNewName&&finalNewName!==currentName){input.disabled=true;await renameFile(path,finalNewName);input.disabled=false}input.style.display="none";input.closest(".file-name").querySelector(".name-text").style.display="block"}else if(e.key==="Escape"){input.value=input.closest(".file-name").getAttribute("data-current-name");input.style.display="none";input.closest(".file-name").querySelector(".name-text").style.display="block"}})});filesList.querySelectorAll(".view-file-btn").forEach(button=>{button.addEventListener("click",()=>{const url=button.getAttribute("data-url");window.open(url,"_blank")})});filesList.querySelectorAll(".insert-file-btn").forEach(button=>{button.addEventListener("click",()=>{const url=button.getAttribute("data-url");const isImage=button.getAttribute("data-is-image")==="true";const name=button.getAttribute("data-name");handleFileInsertion(url,isImage,name)})});filesList.querySelectorAll(".file-item").forEach(item=>{item.style.cursor="default"})}async function loadDocumentFiles(){const filesList=document.querySelector(".files-list");if(!filesList){console.error("Files list element not found");return}try{const docPath=getCurrentDocPath();console.log("Loading files for document path:",docPath);const response=await fetch(`/api/files/list/${docPath}`);if(!response.ok){throw new Error("Failed to fetch files")}const data=await response.json();console.log("API response for files:",data);if(!data.success){throw new Error(data.message||"Failed to fetch files")}let markdown="";if(typeof editor!=="undefined"&&editor&&editor.getValue){markdown=editor.getValue()}else{const codeMirrorElement=document.querySelector(".CodeMirror");if(codeMirrorElement&&codeMirrorElement.CodeMirror){markdown=codeMirrorElement.CodeMirror.getValue()}else{const textareas=document.querySelectorAll("textarea");for(const textarea of textareas){if(textarea.value&&textarea.value.length>0){markdown=textarea.value;break}}}}const mentionedFiles=extractMentionedFilenamesFromMarkdown(markdown);renderFilesList(data.files||[],mentionedFiles);updateFileAttachments(data.files||[])}catch(error){console.error("Error loading files:",error);if(filesList){filesList.innerHTML=`<div class="empty-message">Error: ${error.message||"Failed to load files"}</div>`}}}function updateFileAttachments(files){const fileAttachmentsSection=document.querySelector(".file-attachments-section");const fileAttachmentsList=document.querySelector(".file-attachments-list");if(!fileAttachmentsSection||!fileAttachmentsList)return;console.log("Updating file attachments section:",files);if(!files||files.length===0){fileAttachmentsSection.style.display="none";return}fileAttachmentsSection.style.display="block";const html=files.map(file=>{let safeFile;if(typeof file==="string"){const filename=file;const fileExt=filename.split(".").pop().toLowerCase();let fileType=FILE_EXTENSION_MIME_TYPES[fileExt]||"";safeFile={URL:`/api/files/${getCurrentDocPath()}/${filename}`,Type:fileType,Name:filename,Size:0}}else{safeFile={URL:file.URL||`/api/files/${getCurrentDocPath()}/${file.Name||file.name||"unknown"}`,Type:file.Type||file.type||"",Name:file.Name||file.name||"Unknown file",Size:file.Size||file.size||0}}return`
            <a href="${safeFile.URL}" class="attachment-item" target="_blank" title="Open ${safeFile.Name}">
                <div class="attachment-icon">${getFileIcon(safeFile.Type)}</div>
                <div class="attachment-info">
                    <div class="attachment-name">${safeFile.Name}</div>
                    <div class="attachment-size">${formatFileSize(safeFile.Size)}</div>
                </div>
            </a>
        `}).join("");fileAttachmentsList.innerHTML=html}async function deleteFile(path){console.log("Attempting to delete file at path:",path);showConfirmDialog(window.i18n?window.i18n.t("delete_file.title"):"Delete File",window.i18n?window.i18n.t("delete_file.confirm_message"):"Are you sure you want to delete this file? This action cannot be undone.",async confirmed=>{if(!confirmed){return}try{const deleteUrl=`/api/files/delete/${path}`;console.log("DELETE request to:",deleteUrl);const response=await fetch(deleteUrl,{method:"DELETE"});console.log("Delete response status:",response.status);let data;try{data=await response.json();console.log("Delete response data:",data)}catch(jsonError){console.error("Error parsing JSON response:",jsonError);if(response.ok){loadDocumentFiles();return}else{throw new Error(`HTTP Error: ${response.status} ${response.statusText}`)}}if(!data.success){throw new Error(data.message||"Failed to delete file")}loadDocumentFiles()}catch(error){console.error("Error deleting file:",error);window.DialogSystem.showMessageDialog("Delete Failed",`Error: ${error.message||"Failed to delete file"}. Please check the console for more details.`)}})}function handleFileInsertion(url,isImage,name){if(window.WikiEditor&&window.WikiEditor.insertIntoEditor){const filename=name;if(!window.WikiEditor.insertIntoEditor(url,isImage,filename)){window.DialogSystem.showMessageDialog("Error","Cannot insert file - editor is not active. Try opening the editor first.");return}if(document.querySelector(".file-upload-dialog.active")){loadAndHighlightFilesTab()}}else{window.DialogSystem.showMessageDialog("Error","Cannot insert file - editor interface not available.");return}}async function renameFile(path,newName){console.log("Attempting to rename file at path:",path,"to",newName);try{const response=await fetch("/api/files/rename",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({currentPath:path,newName:newName})});console.log("Rename response status:",response.status);if(response.status===404){console.log("Got 404 status, but checking if rename succeeded anyway");await loadDocumentFiles();setTimeout(()=>{const filesList=document.querySelector(".files-list");if(filesList&&filesList.querySelector(`.file-name[data-current-name="${newName}"]`)){console.log("File with new name found despite 404 error, rename likely succeeded");if(window.DialogSystem&&window.DialogSystem.showToast){window.DialogSystem.showToast(window.i18n?window.i18n.t("file_renamed.success"):"File renamed successfully","success")}return true}else{throw new Error("File not found or rename failed")}},500);return true}const data=await response.json();console.log("Rename response data:",data);if(!data.success){console.error("Server reported error:",data.message);throw new Error(data.message||"Failed to rename file")}if(window.DialogSystem&&window.DialogSystem.showToast){window.DialogSystem.showToast(window.i18n?window.i18n.t("file_renamed.success"):"File renamed successfully","success")}else{console.log("File renamed successfully (toast not available)")}loadDocumentFiles();return true}catch(error){console.error("Error renaming file:",error);const filesList=document.querySelector(".files-list");if(filesList&&filesList.querySelector(`.file-name[data-current-name="${newName}"]`)){console.log("File with new name found in DOM, rename likely succeeded despite error");return true}if(window.DialogSystem&&window.DialogSystem.showMessageDialog){window.DialogSystem.showMessageDialog(window.i18n?window.i18n.t("file_renamed.error_title"):"Rename Failed",`${window.i18n?window.i18n.t("file_renamed.error_message"):"Error"}: ${error.message||"Failed to rename file"}.`)}else{alert("Error renaming file: "+(error.message||"Unknown error"))}return false}}function extractMentionedFilenamesFromMarkdown(markdown){if(!markdown)return[];const linkRegex=/!?\[[^\]]*\]\(([^)]+)\)/g;const matches=[];let match;console.log("Extracting from markdown:",markdown.substring(0,500));while((match=linkRegex.exec(markdown))!==null){const url=match[1].trim();console.log("Found markdown link:",url);if(url&&!url.startsWith("http")&&!url.includes("://")){const parts=url.split("/");const filename=parts[parts.length-1];console.log("Extracted filename:",filename);matches.push(filename)}}console.log("All extracted filenames:",matches);return matches}window.FileUtilities={formatFileSize:formatFileSize,getFileIcon:getFileIcon,renderFilesList:renderFilesList,loadDocumentFiles:loadDocumentFiles,deleteFile:deleteFile,renameFile:renameFile,handleFileInsertion:handleFileInsertion,updateFileAttachments:updateFileAttachments,extractMentionedFilenamesFromMarkdown:extractMentionedFilenamesFromMarkdown};