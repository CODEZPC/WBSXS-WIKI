document.addEventListener("DOMContentLoaded",function(){"use strict";const importForm=document.getElementById("importForm");const importZipFile=document.getElementById("importZipFile");const importButton=document.getElementById("importButton");const cancelImportButton=document.getElementById("cancelImportButton");const importProgressContainer=document.querySelector(".import-progress-container");const importProgressBar=document.getElementById("importProgressBar");const importProgressText=document.getElementById("importProgressText");const importProgressDetails=document.getElementById("importProgressDetails");const importResults=document.querySelector(".import-results");const importResultsContent=document.getElementById("importResults");if(importForm){importForm.addEventListener("submit",handleImportSubmit)}if(cancelImportButton){cancelImportButton.addEventListener("click",resetImportForm)}if(importZipFile){importZipFile.addEventListener("change",function(){if(importButton){importButton.disabled=!importZipFile.files.length}})}async function handleImportSubmit(e){e.preventDefault();if(!importZipFile.files.length){showImportError("Please select a ZIP file to import");return}const file=importZipFile.files[0];if(!file.name.toLowerCase().endsWith(".zip")){showImportError("Please select a valid ZIP file");return}const formData=new FormData;formData.append("zipFile",file);try{showImportProgress();const response=await fetch("/api/import",{method:"POST",body:formData});if(!response.ok){const errorData=await response.json().catch(()=>({}));throw new Error(errorData.message||"Import failed")}const data=await response.json();if(data.statusUrl){pollImportStatus(data.statusUrl)}else{throw new Error("No status URL provided")}}catch(error){console.error("Import error:",error);resetImportProgress();showImportError(error.message||"Failed to start import process")}}async function pollImportStatus(statusUrl){try{const response=await fetch(statusUrl);if(!response.ok){throw new Error("Failed to get import status")}const data=await response.json();updateImportProgress(data);if(data.status==="processing"){setTimeout(()=>pollImportStatus(statusUrl),1e3)}else if(data.status==="completed"){showImportResults(data)}else if(data.status==="failed"){showImportError(data.message||"Import failed");resetImportProgress()}}catch(error){console.error("Error polling import status:",error);showImportError("Failed to get import status");resetImportProgress()}}function updateImportProgress(data){if(!data)return;const progress=data.progress||0;if(importProgressBar){importProgressBar.style.width=`${progress}%`}if(importProgressText){importProgressText.textContent=`${progress}%`}if(importProgressDetails&&data.currentFile){importProgressDetails.textContent=`Processing: ${data.currentFile}`}}function showImportProgress(){if(importButton){importButton.disabled=true;importButton.textContent=window.i18n?window.i18n.t("import.importing"):"Importing..."}if(importZipFile){importZipFile.disabled=true}if(importProgressContainer){importProgressContainer.style.display="block"}if(importResults){importResults.style.display="none"}}function resetImportProgress(){if(importButton){importButton.disabled=false;importButton.textContent=window.i18n?window.i18n.t("import.start_button"):"Import"}if(importZipFile){importZipFile.disabled=false}if(importProgressContainer){importProgressContainer.style.display="none"}if(importProgressBar){importProgressBar.style.width="0%"}if(importProgressText){importProgressText.textContent="0%"}if(importProgressDetails){importProgressDetails.textContent=""}}function showImportResults(data){resetImportProgress();if(!importResults||!importResultsContent)return;importResults.style.display="block";let resultsHtml="";if(data.importedFiles&&data.importedFiles.length){resultsHtml+='<ul class="imported-files-list">';data.importedFiles.forEach(file=>{resultsHtml+=`<li>${file.originalPath} â†’ <a href="${file.newPath}" target="_blank">${file.newPath}</a></li>`});resultsHtml+="</ul>";if(window.SidebarNavigation&&window.SidebarNavigation.refreshSidebar){window.SidebarNavigation.refreshSidebar()}}if(data.errors&&data.errors.length){resultsHtml+="<h5>Errors:</h5>";resultsHtml+='<ul class="import-errors-list">';data.errors.forEach(error=>{resultsHtml+=`<li>${error}</li>`});resultsHtml+="</ul>"}resultsHtml+=`<p class="import-summary">Successfully imported ${data.successCount||0} files with ${data.errorCount||0} errors.</p>`;importResultsContent.innerHTML=resultsHtml}function showImportError(message){const errorMessage=document.querySelector(".settings-dialog .error-message");if(errorMessage){errorMessage.textContent=message;errorMessage.style.display="block"}else{alert(message)}}function resetImportForm(){if(importForm){importForm.reset()}resetImportProgress();if(importResults){importResults.style.display="none"}const errorMessage=document.querySelector(".settings-dialog .error-message");if(errorMessage){errorMessage.style.display="none"}if(importButton){importButton.disabled=true}}window.ImportManager={resetImportForm:resetImportForm}});