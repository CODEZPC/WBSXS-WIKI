const isMac=(()=>{if(navigator.userAgentData){return navigator.userAgentData.platform==="macOS"}return/Mac|iPhone|iPad|iPod/.test(navigator.userAgent)})();const SHORTCUT_DEFINITIONS={enterEditMode:{mac:{cmd:true,key:"e"},other:{ctrl:true,key:"e"},description:"Enter edit mode"},saveDocument:{mac:{cmd:true,key:"s"},other:{ctrl:true,key:"s"},description:"Save document when in edit mode"},focusSearch:{mac:{cmd:true,shift:true,key:"f"},other:{ctrl:true,shift:true,key:"f"},description:"Focus the search box"},formatBold:{mac:{cmd:true,key:"b"},other:{ctrl:true,key:"b"},description:"Toggle bold formatting"},formatItalic:{mac:{cmd:true,key:"i"},other:{ctrl:true,key:"i"},description:"Toggle italic formatting"},formatHeading:{mac:{cmd:true,key:"h"},other:{ctrl:true,key:"h"},description:"Toggle/cycle heading levels"},formatQuote:{mac:{cmd:true,key:"k"},other:{ctrl:true,key:"k"},description:"Toggle block quote"},formatCode:{mac:{cmd:true,key:"/"},other:{ctrl:true,key:"/"},description:"Toggle code formatting"},togglePreview:{mac:{cmd:true,shift:true,key:"p"},other:{ctrl:true,shift:true,key:"p"},description:"Preview Toggle"},toggleWordWrap:{mac:{option:true,key:"z"},other:{alt:true,key:"z"},description:"Toggle word wrap"},toggleLineNumbers:{mac:{option:true,key:"n"},other:{alt:true,key:"n"},description:"Toggle line numbers"},toggleAutocapitalize:{mac:{option:true,key:"c"},other:{alt:true,key:"c"},description:"Toggle auto-capitalize"},tableEscape:{mac:{cmd:true,key:"Enter"},other:{ctrl:true,key:"Enter"},description:"Exit table at current position"},tableMoveLeft:{mac:{cmd:true,key:"ArrowLeft"},other:{ctrl:true,key:"ArrowLeft"},description:"Move to cell on the left"},tableMoveRight:{mac:{cmd:true,key:"ArrowRight"},other:{ctrl:true,key:"ArrowRight"},description:"Move to cell on the right"},tableMoveUp:{mac:{cmd:true,key:"ArrowUp"},other:{ctrl:true,key:"ArrowUp"},description:"Move to cell above"},tableMoveDown:{mac:{cmd:true,key:"ArrowDown"},other:{ctrl:true,key:"ArrowDown"},description:"Move to cell below"},tableAlignLeft:{mac:{cmd:true,shift:true,key:"ArrowLeft"},other:{ctrl:true,shift:true,key:"ArrowLeft"},description:"Align column left"},tableAlignRight:{mac:{cmd:true,shift:true,key:"ArrowRight"},other:{ctrl:true,shift:true,key:"ArrowRight"},description:"Align column right"},tableAlignCenter:{mac:{cmd:true,shift:true,key:"ArrowUp"},other:{ctrl:true,shift:true,key:"ArrowUp"},description:"Align column center"},tableAlignNone:{mac:{cmd:true,shift:true,key:"ArrowDown"},other:{ctrl:true,shift:true,key:"ArrowDown"},description:"Remove column alignment"},tableMoveRowUp:{mac:{option:true,key:"ArrowUp"},other:{alt:true,key:"ArrowUp"},description:"Move row up"},tableMoveRowDown:{mac:{option:true,key:"ArrowDown"},other:{alt:true,key:"ArrowDown"},description:"Move row down"},tableMoveColumnLeft:{mac:{option:true,key:"ArrowLeft"},other:{alt:true,key:"ArrowLeft"},description:"Move column left"},tableMoveColumnRight:{mac:{option:true,key:"ArrowRight"},other:{alt:true,key:"ArrowRight"},description:"Move column right"}};let mainContent;let editorContainer;let viewToolbar;let editToolbar;let editPageButton;let saveButton;function matchesShortcut(event,shortcut){const platform=isMac?"mac":"other";const platformShortcut=shortcut[platform];if(!platformShortcut)return false;let eventKey=event.key;if(eventKey==="ArrowLeft")eventKey="ArrowLeft";else if(eventKey==="ArrowRight")eventKey="ArrowRight";else if(eventKey==="ArrowUp")eventKey="ArrowUp";else if(eventKey==="ArrowDown")eventKey="ArrowDown";else if(event.code==="Slash")eventKey="/";else eventKey=eventKey.toLowerCase();const targetKey=platformShortcut.key.toLowerCase();return(!platformShortcut.ctrl||event.ctrlKey)&&(!platformShortcut.cmd||event.metaKey)&&(!platformShortcut.meta||event.metaKey)&&(!platformShortcut.alt||event.altKey)&&(!platformShortcut.option||event.altKey)&&(!platformShortcut.shift||event.shiftKey)&&(eventKey===targetKey||eventKey===platformShortcut.key)}function getShortcutAction(event){for(const[actionName,shortcut]of Object.entries(SHORTCUT_DEFINITIONS)){if(matchesShortcut(event,shortcut)){return actionName}}return null}function initKeyboardShortcuts(){mainContent=document.querySelector(".content");editorContainer=document.querySelector(".editor-container");viewToolbar=document.querySelector(".view-toolbar");editToolbar=document.querySelector(".edit-toolbar");editPageButton=document.querySelector(".edit-page");saveButton=document.querySelector(".save-changes");document.addEventListener("keydown",handleKeyDown);if(window.CodeMirror){registerFormattingCommands();registerAllCodeMirrorShortcuts()}}function registerAllCodeMirrorShortcuts(){if(!CodeMirror.keyMap.default){CodeMirror.keyMap.default={}}if(isMac){CodeMirror.keyMap.default["Cmd-B"]="formatBold";CodeMirror.keyMap.default["Cmd-I"]="formatItalic";CodeMirror.keyMap.default["Cmd-H"]="formatHeading";CodeMirror.keyMap.default["Cmd-K"]="formatQuote";CodeMirror.keyMap.default["Cmd-/"]="formatCode";CodeMirror.keyMap.default["Cmd-Shift-P"]="togglePreview";CodeMirror.keyMap.default["Alt-Z"]="toggleWordWrap";CodeMirror.keyMap.default["Alt-N"]="toggleLineNumbers";CodeMirror.keyMap.default["Alt-C"]="toggleAutocapitalize";CodeMirror.keyMap.default["Cmd-Enter"]="tableEscape";CodeMirror.keyMap.default["Cmd-Left"]="tableMoveLeft";CodeMirror.keyMap.default["Cmd-Right"]="tableMoveRight";CodeMirror.keyMap.default["Cmd-Up"]="tableMoveUp";CodeMirror.keyMap.default["Cmd-Down"]="tableMoveDown";CodeMirror.keyMap.default["Shift-Cmd-Left"]="tableAlignLeft";CodeMirror.keyMap.default["Shift-Cmd-Right"]="tableAlignRight";CodeMirror.keyMap.default["Shift-Cmd-Up"]="tableAlignCenter";CodeMirror.keyMap.default["Shift-Cmd-Down"]="tableAlignNone";CodeMirror.keyMap.default["Alt-Up"]="markdownTableMoveRowUp";CodeMirror.keyMap.default["Alt-Down"]="markdownTableMoveRowDown";CodeMirror.keyMap.default["Alt-Left"]="markdownTableMoveColumnLeft";CodeMirror.keyMap.default["Alt-Right"]="markdownTableMoveColumnRight"}else{CodeMirror.keyMap.default["Ctrl-B"]="formatBold";CodeMirror.keyMap.default["Ctrl-I"]="formatItalic";CodeMirror.keyMap.default["Ctrl-H"]="formatHeading";CodeMirror.keyMap.default["Ctrl-K"]="formatQuote";CodeMirror.keyMap.default["Ctrl-/"]="formatCode";CodeMirror.keyMap.default["Ctrl-Shift-P"]="togglePreview";CodeMirror.keyMap.default["Alt-Z"]="toggleWordWrap";CodeMirror.keyMap.default["Alt-N"]="toggleLineNumbers";CodeMirror.keyMap.default["Alt-C"]="toggleAutocapitalize";CodeMirror.keyMap.default["Ctrl-Enter"]="tableEscape";CodeMirror.keyMap.default["Ctrl-Left"]="tableMoveLeft";CodeMirror.keyMap.default["Ctrl-Right"]="tableMoveRight";CodeMirror.keyMap.default["Ctrl-Up"]="tableMoveUp";CodeMirror.keyMap.default["Ctrl-Down"]="tableMoveDown";CodeMirror.keyMap.default["Shift-Ctrl-Left"]="tableAlignLeft";CodeMirror.keyMap.default["Shift-Ctrl-Right"]="tableAlignRight";CodeMirror.keyMap.default["Shift-Ctrl-Up"]="tableAlignCenter";CodeMirror.keyMap.default["Shift-Ctrl-Down"]="tableAlignNone";CodeMirror.keyMap.default["Alt-Up"]="markdownTableMoveRowUp";CodeMirror.keyMap.default["Alt-Down"]="markdownTableMoveRowDown";CodeMirror.keyMap.default["Alt-Left"]="markdownTableMoveColumnLeft";CodeMirror.keyMap.default["Alt-Right"]="markdownTableMoveColumnRight"}}function registerFormattingCommands(){CodeMirror.commands.formatBold=function(cm){const selection=cm.getSelection();if(selection){cm.replaceSelection(`**${selection}**`);const cursor=cm.getCursor();cm.setCursor(cursor)}else{const cursor=cm.getCursor();cm.replaceRange("**",cursor);cm.setCursor({line:cursor.line,ch:cursor.ch});cm.replaceRange("**",cursor);cm.setCursor({line:cursor.line,ch:cursor.ch})}cm.focus()};CodeMirror.commands.formatItalic=function(cm){const selection=cm.getSelection();if(selection){cm.replaceSelection(`*${selection}*`);const cursor=cm.getCursor();cm.setCursor(cursor)}else{const cursor=cm.getCursor();cm.replaceRange("*",cursor);cm.setCursor({line:cursor.line,ch:cursor.ch});cm.replaceRange("*",cursor);cm.setCursor({line:cursor.line,ch:cursor.ch})}cm.focus()};CodeMirror.commands.formatHeading=function(cm){const cursor=cm.getCursor();const line=cm.getLine(cursor.line);const lineWithoutIndent=line.trimStart();const indent=line.length-lineWithoutIndent.length;let headingLevel=0;for(let i=indent;i<line.length;i++){if(line[i]==="#"){headingLevel++}else if(line[i]!==" "){break}}if(headingLevel>0&&headingLevel<6){const newPrefix=" ".repeat(indent)+"#".repeat(headingLevel+1)+" ";const content=line.substring(indent+headingLevel+(line[indent+headingLevel]===" "?1:0)).trim();cm.replaceRange(newPrefix+content,{line:cursor.line,ch:0},{line:cursor.line,ch:line.length});cm.setCursor({line:cursor.line,ch:newPrefix.length+content.length})}else if(headingLevel>=6){const content=line.substring(indent+headingLevel+(line[indent+headingLevel]===" "?1:0)).trim();cm.replaceRange(" ".repeat(indent)+content,{line:cursor.line,ch:0},{line:cursor.line,ch:line.length});cm.setCursor({line:cursor.line,ch:indent+content.length})}else{const newPrefix=" ".repeat(indent)+"# ";const content=lineWithoutIndent;cm.replaceRange(newPrefix+content,{line:cursor.line,ch:0},{line:cursor.line,ch:line.length});cm.setCursor({line:cursor.line,ch:newPrefix.length+content.length})}cm.focus()};CodeMirror.commands.formatQuote=function(cm){const cursor=cm.getCursor();const line=cm.getLine(cursor.line);const trimmedLine=line.trimStart();const indentSize=line.length-trimmedLine.length;if(trimmedLine.startsWith(">")){const quoteContent=trimmedLine.substring(1).trimStart();cm.replaceRange(" ".repeat(indentSize)+quoteContent,{line:cursor.line,ch:0},{line:cursor.line,ch:line.length});cm.setCursor({line:cursor.line,ch:indentSize+quoteContent.length})}else{const newPrefix=" ".repeat(indentSize)+"> ";cm.replaceRange(newPrefix+trimmedLine,{line:cursor.line,ch:0},{line:cursor.line,ch:line.length});cm.setCursor({line:cursor.line,ch:newPrefix.length+trimmedLine.length})}cm.focus()};CodeMirror.commands.formatCode=function(cm){const selection=cm.getSelection();const cursor=cm.getCursor();if(selection){const hasMultipleLines=selection.includes("\n");if(hasMultipleLines){const lines=selection.split("\n");const isCodeBlock=lines.length>=2&&lines[0].trim().startsWith("```")&&lines[lines.length-1].trim()==="```";if(isCodeBlock){const contentLines=lines.slice(1,lines.length-1);cm.replaceSelection(contentLines.join("\n"))}else{cm.replaceSelection("```\n"+selection+"\n```")}}else{const isInlineCode=selection.startsWith("`")&&selection.endsWith("`");if(isInlineCode){cm.replaceSelection(selection.substring(1,selection.length-1))}else{cm.replaceSelection("`"+selection+"`")}}}else{const line=cursor.line;const lineText=cm.getLine(line);const prevLine=line>0?cm.getLine(line-1):"";const nextLine=line<cm.lineCount()-1?cm.getLine(line+1):"";const isInCodeBlock=prevLine.trim()==="```"&&nextLine.trim()==="```";if(isInCodeBlock){cm.replaceRange("",{line:line+1,ch:0},{line:line+2,ch:0});cm.replaceRange("",{line:line-1,ch:0},{line:line,ch:0})}else{cm.replaceRange("\n```",{line:line,ch:lineText.length});cm.replaceRange("```\n",{line:line,ch:0});cm.setCursor({line:line+1,ch:cursor.ch})}}cm.focus()};CodeMirror.commands.togglePreview=function(cm){if(window.EditorPreview&&typeof window.EditorPreview.togglePreview==="function"){window.EditorPreview.togglePreview()}};CodeMirror.commands.toggleWordWrap=function(cm){if(window.EditorCore&&typeof window.EditorCore.toggleWordWrap==="function"){window.EditorCore.toggleWordWrap()}};CodeMirror.commands.toggleLineNumbers=function(cm){if(window.EditorCore&&typeof window.EditorCore.toggleLineNumbers==="function"){window.EditorCore.toggleLineNumbers()}};CodeMirror.commands.toggleAutocapitalize=function(cm){if(window.EditorCore&&typeof window.EditorCore.toggleAutocapitalize==="function"){window.EditorCore.toggleAutocapitalize()}}}function handleKeyDown(e){const action=getShortcutAction(e);if(action){switch(action){case"enterEditMode":e.preventDefault();if(editPageButton&&!mainContent.classList.contains("editing")){fetch("/api/check-auth").then(authResponse=>{if(authResponse.status===401){window.Auth.showLoginDialog(()=>{window.Auth.checkUserRole("editor").then(canEdit=>{if(canEdit){const url=new URL(window.location);url.searchParams.set("mode","edit");window.location.href=url.toString()}else{window.Auth.showPermissionError("editor")}})});return}window.Auth.checkUserRole("editor").then(canEdit=>{if(canEdit){const url=new URL(window.location);url.searchParams.set("mode","edit");window.location.href=url.toString()}else{window.Auth.showPermissionError("editor")}})})}return;case"saveDocument":e.preventDefault();if(mainContent&&mainContent.classList.contains("editing")&&saveButton){saveButton.click()}return;case"focusSearch":e.preventDefault();const searchBox=document.querySelector(".search-box");if(searchBox){searchBox.focus()}return;case"togglePreview":e.preventDefault();if(mainContent&&mainContent.classList.contains("editing")){if(window.EditorPreview&&typeof window.EditorPreview.togglePreview==="function"){window.EditorPreview.togglePreview()}}return}}if(e.key==="Escape"){handleEscapeKey(e)}}function handleEscapeKey(e){const versionHistoryDialog=document.querySelector(".version-history-dialog");const isVersionHistoryDialogOpen=versionHistoryDialog&&versionHistoryDialog.classList.contains("active");const isFileUploadDialogOpen=document.querySelector(".file-upload-dialog")?.classList.contains("active");const isLoginDialogOpen=document.querySelector(".login-dialog")?.classList.contains("active");const isMessageDialogOpen=document.querySelector(".message-dialog")?.classList.contains("active");const isDeleteConfirmDialogOpen=document.querySelector(".confirmation-dialog")?.classList.contains("active");const isUserConfirmDialogOpen=document.querySelector(".user-confirmation-dialog")?.classList.contains("active");const isNewDocDialogOpen=document.querySelector(".new-document-dialog")?.classList.contains("active");const isSettingsDialogOpen=document.querySelector(".settings-dialog")?.classList.contains("active");const isMoveDocDialogOpen=document.querySelector(".move-document-dialog")?.classList.contains("active");const isAddLinkDialogOpen=document.querySelector(".add-link-dialog")?.classList.contains("active");const isSearchResultsOpen=document.querySelector(".search-results")?.classList.contains("active");const isActionsMenuOpen=document.querySelector(".page-actions-menu")?.classList.contains("active");const isEditing=mainContent&&mainContent.classList.contains("editing");if(isLoginDialogOpen){window.Auth.hideLoginDialog();e.preventDefault()}else if(isMessageDialogOpen){window.DialogSystem.hideMessageDialog();e.preventDefault()}else if(isUserConfirmDialogOpen){window.DialogSystem.hideConfirmDialog();e.preventDefault()}else if(isVersionHistoryDialogOpen){window.VersionHistory.hideVersionHistoryDialog();e.preventDefault();return}else if(isFileUploadDialogOpen){window.FileUpload.hideFileUploadDialog();e.preventDefault()}else if(isMoveDocDialogOpen){window.MoveDocument.hideMoveDocDialog();e.preventDefault()}else if(isDeleteConfirmDialogOpen){window.DocumentManager.hideConfirmationDialog();e.preventDefault()}else if(isNewDocDialogOpen){window.DocumentManager.hideNewDocDialog();e.preventDefault()}else if(isSettingsDialogOpen){window.SettingsManager.hideSettingsDialog();e.preventDefault()}else if(isAddLinkDialogOpen){if(window.LinksInteractivity&&window.LinksInteractivity.hideAddLinkDialog){window.LinksInteractivity.hideAddLinkDialog()}else{const dialog=document.querySelector(".add-link-dialog");if(dialog){dialog.classList.remove("active")}}e.preventDefault()}else if(isSearchResultsOpen){window.Search.hideSearchResults();e.preventDefault()}else if(isActionsMenuOpen){document.querySelector(".page-actions-menu").classList.remove("active");e.preventDefault()}else if(isEditing){e.preventDefault();if(window.WikiEditor&&window.WikiEditor.hasUnsavedChanges&&window.WikiEditor.hasUnsavedChanges()){if(window.WikiEditor.showUnsavedChangesDialog){window.WikiEditor.showUnsavedChangesDialog(function(){const saveButton=document.querySelector(".save-changes");if(saveButton){saveButton.click()}},function(){const url=new URL(window.location);url.searchParams.delete("mode");window.location.href=url.pathname+url.search})}}else{const url=new URL(window.location);url.searchParams.delete("mode");window.location.href=url.pathname+url.search}}}function exitEditMode(){if(window.WikiEditor&&typeof window.WikiEditor.exitEditMode==="function"){window.WikiEditor.exitEditMode(mainContent,editorContainer,viewToolbar,editToolbar)}}window.KeyboardShortcuts={init:initKeyboardShortcuts,handleKeyDown:handleKeyDown,handleEscapeKey:handleEscapeKey,exitEditMode:exitEditMode,registerFormattingCommands:registerFormattingCommands,registerAllCodeMirrorShortcuts:registerAllCodeMirrorShortcuts};document.addEventListener("DOMContentLoaded",initKeyboardShortcuts);