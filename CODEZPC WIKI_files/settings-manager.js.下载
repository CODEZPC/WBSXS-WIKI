document.addEventListener("DOMContentLoaded",function(){"use strict";let maxFileUploadSizeMB=20;let maxFileUploadSizeBytes=maxFileUploadSizeMB*1024*1024;let disableFileUploadChecking=false;const settingsButton=document.querySelector(".settings-button");const settingsDialog=document.querySelector(".settings-dialog");const closeSettingsDialog=settingsDialog.querySelector(".close-dialog");const cancelSettingsButtons=settingsDialog.querySelectorAll(".cancel-settings");const generalSettingsForm=document.getElementById("wikiSettingsForm");const contentSettingsForm=document.getElementById("contentSettingsForm");const securitySettingsForm=document.getElementById("securitySettingsForm");const settingsErrorMessage=settingsDialog.querySelector(".error-message");const tabButtons=document.querySelectorAll(".tab-button");const tabPanes=document.querySelectorAll(".tab-pane");tabButtons.forEach(button=>{button.addEventListener("click",function(){const tabId=this.getAttribute("data-tab");tabButtons.forEach(btn=>btn.classList.remove("active"));tabPanes.forEach(pane=>pane.classList.remove("active"));this.classList.add("active");document.getElementById(tabId).classList.add("active")})});if(settingsButton){settingsButton.addEventListener("click",async function(){try{const authResponse=await fetch("/api/check-auth");if(authResponse.status===401){window.Auth.showLoginDialog(()=>{window.Auth.checkIfUserIsAdmin().then(isAdmin=>{if(isAdmin){loadSettings();window.Auth.updateToolbarButtons()}else{window.Auth.showAdminOnlyError()}})});return}const isAdmin=await window.Auth.checkIfUserIsAdmin();if(isAdmin){loadSettings();setTimeout(()=>{const firstTabButton=document.querySelector('.settings-tabs .tab-button[data-tab="general-tab"]');const firstTabPane=document.getElementById("general-tab");if(firstTabButton&&firstTabPane){document.querySelectorAll(".settings-tabs .tab-button").forEach(btn=>{btn.classList.remove("active")});document.querySelectorAll(".tab-pane").forEach(pane=>{pane.classList.remove("active")});firstTabButton.classList.add("active");firstTabPane.classList.add("active")}},50)}else{window.Auth.showAdminOnlyError()}}catch(error){console.error("Error:",error);alert("Failed to check authentication status")}})}if(closeSettingsDialog){closeSettingsDialog.addEventListener("click",hideSettingsDialog)}cancelSettingsButtons.forEach(button=>{if(button){button.addEventListener("click",hideSettingsDialog)}});function collectAllSettings(){const wikiSettings={title:document.getElementById("wikiTitle").value.trim(),owner:document.getElementById("wikiOwner").value.trim(),notice:document.getElementById("wikiNotice").value.trim(),timezone:document.getElementById("wikiTimezone").value.trim(),private:document.getElementById("wikiPrivate").checked,disable_comments:document.getElementById("wikiDisableComments").checked,disable_file_upload_checking:document.getElementById("wikiDisableFileUploadChecking").checked,enable_link_embedding:document.getElementById("wikiEnableLinkEmbedding").checked,hide_attachments:document.getElementById("wikiHideAttachments").checked,disable_content_max_width:document.getElementById("wikiDisableContentMaxWidth").checked,max_versions:parseInt(document.getElementById("wikiMaxVersions").value,10)||0,max_upload_size:parseInt(document.getElementById("wikiMaxUploadSize").value,10)||20,language:document.getElementById("wikiLanguage").value};if(!wikiSettings.title||!wikiSettings.owner||!wikiSettings.notice||!wikiSettings.timezone){return{valid:false,error:"All fields are required"}}if(isNaN(wikiSettings.max_versions)||wikiSettings.max_versions<0){return{valid:false,error:"Document versions must be a non-negative number"}}return{valid:true,settings:wikiSettings}}if(generalSettingsForm){generalSettingsForm.addEventListener("submit",async function(e){e.preventDefault();await saveSettings()})}if(contentSettingsForm){contentSettingsForm.addEventListener("submit",async function(e){e.preventDefault();await saveSettings()})}if(securitySettingsForm){securitySettingsForm.addEventListener("submit",async function(e){e.preventDefault();await saveSecuritySettings()});const loginBanCheckbox=document.getElementById("loginBanEnabled");const loginBanFields=["loginBanMaxFailures","loginBanWindow","loginBanInitial","loginBanMax"];function updateLoginBanFields(){const isEnabled=loginBanCheckbox.checked;loginBanFields.forEach(fieldId=>{const field=document.getElementById(fieldId);field.disabled=!isEnabled})}loginBanCheckbox.addEventListener("change",updateLoginBanFields);const originalLoadSettings=loadSettings;loadSettings=async function(){await originalLoadSettings();updateLoginBanFields()}}async function saveSettings(){const result=collectAllSettings();if(!result.valid){settingsErrorMessage.textContent=result.error;settingsErrorMessage.style.display="block";return false}const wikiSettings=result.settings;const currentLanguage=document.documentElement.lang;const newLanguage=wikiSettings.language;const languageChanged=currentLanguage!==newLanguage;try{const response=await fetch("/api/settings/wiki",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(wikiSettings)});if(response.ok){document.dispatchEvent(new CustomEvent("settings-updated",{detail:wikiSettings}));if(languageChanged){hideSettingsDialog();window.location.reload()}else{window.location.reload()}return true}else{const errorData=await response.json().catch(()=>null);if(errorData&&errorData.message){settingsErrorMessage.textContent=errorData.message}else{settingsErrorMessage.textContent="Failed to save settings"}settingsErrorMessage.style.display="block";return false}}catch(error){console.error("Error saving settings:",error);settingsErrorMessage.textContent="An error occurred while saving settings";settingsErrorMessage.style.display="block";return false}}async function loadSettings(){try{const response=await fetch("/api/settings/wiki");if(!response.ok){throw new Error("Failed to fetch settings")}const settings=await response.json();document.getElementById("wikiTitle").value=settings.title||"";document.getElementById("wikiOwner").value=settings.owner||"";document.getElementById("wikiNotice").value=settings.notice||"";document.getElementById("wikiTimezone").value=settings.timezone||"";document.getElementById("wikiLanguage").value=settings.language||"en";document.getElementById("wikiPrivate").checked=settings.private||false;document.getElementById("wikiDisableComments").checked=settings.disable_comments||false;document.getElementById("wikiDisableFileUploadChecking").checked=settings.disable_file_upload_checking||false;document.getElementById("wikiEnableLinkEmbedding").checked=settings.enable_link_embedding||false;document.getElementById("wikiHideAttachments").checked=settings.hide_attachments||false;document.getElementById("wikiDisableContentMaxWidth").checked=settings.disable_content_max_width||false;document.getElementById("wikiMaxVersions").value=settings.max_versions!==undefined?settings.max_versions:10;document.getElementById("wikiMaxUploadSize").value=settings.max_upload_size!==undefined?settings.max_upload_size:20;maxFileUploadSizeMB=settings.max_upload_size||20;maxFileUploadSizeBytes=maxFileUploadSizeMB*1024*1024;if(settings&&settings.disable_file_upload_checking!==undefined){disableFileUploadChecking=settings.disable_file_upload_checking;console.log(`Disable file upload checking: ${disableFileUploadChecking}`)}loadUsers();settingsDialog.classList.add("active");settingsErrorMessage.style.display="none";const firstTabButton=document.querySelector('.settings-tabs .tab-button[data-tab="general-tab"]');const firstTabPane=document.getElementById("general-tab");if(firstTabButton&&firstTabPane){document.querySelectorAll(".settings-tabs .tab-button").forEach(btn=>{btn.classList.remove("active")});document.querySelectorAll(".settings-dialog .tab-pane").forEach(pane=>{pane.classList.remove("active")});firstTabButton.classList.add("active");firstTabPane.classList.add("active")}try{const secResp=await fetch("/api/settings/security");if(secResp.ok){const sec=await secResp.json();document.getElementById("loginBanEnabled").checked=sec.login_ban.enabled;document.getElementById("loginBanMaxFailures").value=sec.login_ban.max_failures;document.getElementById("loginBanWindow").value=sec.login_ban.window_seconds;document.getElementById("loginBanInitial").value=sec.login_ban.initial_ban_seconds;document.getElementById("loginBanMax").value=sec.login_ban.max_ban_seconds}}catch(e){}}catch(error){console.error("Error loading settings:",error);alert("Failed to load settings")}}function hideSettingsDialog(){settingsDialog.classList.remove("active")}const usersList=document.querySelector(".users-list");const userForm=document.getElementById("userForm");const userFormTitle=document.getElementById("user-form-title");const userFormMode=document.getElementById("userFormMode");const userFormUsernameInput=document.getElementById("userFormUsername");const passwordInput=document.getElementById("userFormPassword");const passwordHelp=document.getElementById("password-help");const userRoleSelect=document.getElementById("userRole");const saveUserBtn=document.getElementById("saveUserBtn");const cancelUserBtn=document.getElementById("cancelUserBtn");if(userForm){userForm.addEventListener("submit",handleUserFormSubmit)}if(cancelUserBtn){cancelUserBtn.addEventListener("click",resetUserForm)}const usersListContainer=document.querySelector(".users-list-container");if(usersListContainer){const addUserBtn=document.createElement("button");addUserBtn.className="add-user-btn";addUserBtn.setAttribute("data-i18n","users.add_new");addUserBtn.textContent="Add New User";addUserBtn.addEventListener("click",resetUserForm);usersListContainer.insertBefore(addUserBtn,usersListContainer.querySelector(".users-list"))}async function loadUsers(){try{const response=await fetch("/api/users");if(!response.ok){throw new Error("Failed to load users")}const data=await response.json();renderUsersList(data.users);if(!usersListContainer.querySelector(".add-user-btn")){const addUserBtn=document.createElement("button");addUserBtn.className="add-user-btn";addUserBtn.setAttribute("data-i18n","users.add_new");addUserBtn.textContent="Add New User";addUserBtn.addEventListener("click",resetUserForm);usersListContainer.insertBefore(addUserBtn,usersListContainer.querySelector(".users-list"));if(window.i18n){window.i18n.translateElement(addUserBtn)}}}catch(error){console.error("Error loading users:",error)}}function renderUsersList(users){if(!usersList)return;if(!users||users.length===0){usersList.innerHTML='<div class="empty-message">No users found</div>';return}const currentUsername=document.cookie.split("; ").find(row=>row.startsWith("session_user="))?.split("=")[1];users.sort((a,b)=>{const roleA=a.role||(a.is_admin?"admin":"viewer");const roleB=b.role||(b.is_admin?"admin":"viewer");const rolePriority={admin:0,editor:1,viewer:2};if(rolePriority[roleA]!==rolePriority[roleB]){return rolePriority[roleA]-rolePriority[roleB]}return a.username.localeCompare(b.username)});const html=users.map(user=>{const isCurrentUser=user.username===currentUsername;const role=user.role||(user.is_admin?"admin":"viewer");let roleDisplay=role.charAt(0).toUpperCase()+role.slice(1);if(window.i18n&&window.i18n.t){roleDisplay=window.i18n.t(`users.role_${role}`)}const roleBadgeClass=`role-badge role-${role}`;return`
                <div class="user-item" data-username="${user.username}">
                    <div class="user-info">
                        <span class="username">${user.username}</span>
                        <span class="${roleBadgeClass}">${roleDisplay}</span>
                        ${isCurrentUser?`<span class="current-user-badge">${window.i18n?window.i18n.t("common.you"):"You"}</span>`:""}
                    </div>
                    <div class="user-actions">
                        <button class="edit-user-btn" title="Edit user" data-username="${user.username}" data-user='${JSON.stringify({role:role,is_admin:user.is_admin})}'>
                            <i class="fa fa-pencil"></i>
                        </button>
                        ${!isCurrentUser?`
                        <button class="delete-user-btn" title="Delete user" data-username="${user.username}">
                            <i class="fa fa-trash"></i>
                        </button>
                        `:""}
                    </div>
                </div>
            `}).join("");usersList.innerHTML=html;usersList.querySelectorAll(".edit-user-btn").forEach(button=>{button.addEventListener("click",()=>{const username=button.getAttribute("data-username");const userData=JSON.parse(button.getAttribute("data-user"));editUser(username,userData)})});usersList.querySelectorAll(".delete-user-btn").forEach(button=>{button.addEventListener("click",()=>{const username=button.getAttribute("data-username");deleteUser(username)})})}function resetUserForm(){userFormMode.value="create";userFormTitle.textContent="Add New User";userFormTitle.setAttribute("data-i18n","users.add_user_title");userFormUsernameInput.value="";userFormUsernameInput.disabled=false;passwordInput.value="";passwordHelp.style.display="none";passwordInput.required=true;userRoleSelect.value="viewer";saveUserBtn.textContent="Add User";saveUserBtn.setAttribute("data-i18n","users.add_button");cancelUserBtn.textContent="Clear";cancelUserBtn.setAttribute("data-i18n","users.clear_button");if(window.i18n){window.i18n.translateElement(userFormTitle);window.i18n.translateElement(saveUserBtn);window.i18n.translateElement(cancelUserBtn)}const usersTabButton=document.querySelector('.tab-button[data-tab="users-tab"]');if(usersTabButton){usersTabButton.click()}}function editUser(username,user){userFormMode.value="update";userFormTitle.removeAttribute("data-i18n");userFormTitle.textContent=`Edit User: ${username}`;userFormUsernameInput.value=username;userFormUsernameInput.disabled=true;passwordInput.value="";passwordHelp.style.display="block";passwordInput.required=false;if(user.role){userRoleSelect.value=user.role}else{userRoleSelect.value=user.is_admin?"admin":"viewer"}saveUserBtn.textContent="Update User";saveUserBtn.setAttribute("data-i18n","users.update_button");cancelUserBtn.textContent="Clear";cancelUserBtn.setAttribute("data-i18n","users.clear_button");if(window.i18n){window.i18n.translateElement(saveUserBtn);window.i18n.translateElement(cancelUserBtn);if(window.i18n.t){const editUserTitle=window.i18n.t("users.edit_user_title");userFormTitle.textContent=`${editUserTitle}: ${username}`}}const usersTabButton=document.querySelector('.tab-button[data-tab="users-tab"]');if(usersTabButton){usersTabButton.click()}}async function handleUserFormSubmit(e){e.preventDefault();const mode=userFormMode.value;const username=userFormUsernameInput.value.trim();const password=passwordInput.value;const role=userRoleSelect.value;if(!username){window.DialogSystem.showMessageDialog("Form Error","Username is required");return}if(mode==="create"&&!password){window.DialogSystem.showMessageDialog("Form Error","Password is required for new users");return}try{let response;if(mode==="create"){response=await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,password:password,role:role})})}else{response=await fetch("/api/users",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:username,new_password:password||undefined,role:role})})}if(!response.ok){const errorData=await response.json().catch(()=>null);throw new Error(errorData?.message||`Failed to ${mode} user`)}loadUsers();resetUserForm();window.Auth.checkDefaultPassword()}catch(error){console.error(`Error ${mode==="create"?"creating":"updating"} user:`,error);window.DialogSystem.showMessageDialog("User Operation Failed",error.message||`Failed to ${mode} user`)}}async function deleteUser(username){const title=window.i18n?window.i18n.t("delete_user.title"):"Delete User";const message=window.i18n?window.i18n.t("delete_user.confirm_message").replace("{0}",username):`Are you sure you want to delete user "${username}"? This action cannot be undone.`;window.DialogSystem.showConfirmDialog(title,message,async confirmed=>{if(!confirmed){return}try{const response=await fetch(`/api/users?username=${encodeURIComponent(username)}`,{method:"DELETE"});if(!response.ok){const errorData=await response.json().catch(()=>null);throw new Error(errorData?.message||"Failed to delete user")}loadUsers();resetUserForm();window.Auth.checkDefaultPassword()}catch(error){console.error("Error deleting user:",error);window.DialogSystem.showMessageDialog("Delete Failed",error.message||"Failed to delete user")}})}async function fetchMaxUploadSize(){try{const response=await fetch("/api/settings/wiki");if(response.ok){const settings=await response.json();if(settings&&settings.max_upload_size){maxFileUploadSizeMB=settings.max_upload_size;maxFileUploadSizeBytes=maxFileUploadSizeMB*1024*1024;console.log(`Max upload size updated to ${maxFileUploadSizeMB}MB`)}if(settings&&settings.disable_file_upload_checking!==undefined){disableFileUploadChecking=settings.disable_file_upload_checking;console.log(`Disable file upload checking: ${disableFileUploadChecking}`)}}else if(response.status===401){console.log(`Using default max upload size of ${maxFileUploadSizeMB}MB`);console.log(`Using default file upload checking (enabled)`)}}catch(error){console.error("Error fetching settings:",error)}}async function saveSecuritySettings(){const payload={login_ban:{enabled:document.getElementById("loginBanEnabled").checked,max_failures:parseInt(document.getElementById("loginBanMaxFailures").value,10)||3,window_seconds:parseInt(document.getElementById("loginBanWindow").value,10)||30,initial_ban_seconds:parseInt(document.getElementById("loginBanInitial").value,10)||60,max_ban_seconds:parseInt(document.getElementById("loginBanMax").value,10)||86400}};try{const resp=await fetch("/api/settings/security",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(resp.ok){window.location.reload()}else{settingsErrorMessage.textContent="Failed to save security settings";settingsErrorMessage.style.display="block"}}catch(e){console.error(e);settingsErrorMessage.textContent="Error saving security settings";settingsErrorMessage.style.display="block"}}window.SettingsManager={hideSettingsDialog:hideSettingsDialog,fetchMaxUploadSize:fetchMaxUploadSize,loadSettings:loadSettings,maxFileUploadSizeMB:()=>maxFileUploadSizeMB,maxFileUploadSizeBytes:()=>maxFileUploadSizeBytes,isFileUploadCheckingDisabled:()=>disableFileUploadChecking}});