(function(){document.addEventListener("DOMContentLoaded",()=>{if(!window.TaskListPermissions||!window.TaskListPermissions.isTaskEditingAllowed()){console.log("tasklist-live.js: Task editing not allowed, aborting");return}const docPath=window.TaskListPermissions.getDocPath();const container=document.querySelector(".markdown-content");if(!container)return;const isKanbanCheckbox=checkbox=>{return checkbox.closest(".kanban-column-content")!==null};const allCheckboxes=[...container.querySelectorAll('input[type="checkbox"]')].filter(cb=>!isKanbanCheckbox(cb));allCheckboxes.forEach((cb,idx)=>{cb.dataset.cbIndex=idx});console.log(`tasklist-live.js: Managing ${allCheckboxes.length} regular task checkboxes (excluding kanban)`);const toggleAll=disabled=>{allCheckboxes.forEach(cb=>cb.disabled=disabled)};container.querySelectorAll("li").forEach(li=>{if(!li.querySelector('input[type="checkbox"]'))return;if(isKanbanCheckbox(li.querySelector('input[type="checkbox"]')))return;if(!li.querySelector(".save-state")){const span=document.createElement("span");span.className="save-state";const firstUL=li.querySelector("ul");if(firstUL){li.insertBefore(span,firstUL)}else{li.appendChild(span)}}});const showState=(li,text,cssClass)=>{const s=li.querySelector(".save-state");if(!s)return;s.textContent=text;s.classList.remove("saved","error");if(cssClass)s.classList.add(cssClass);setTimeout(()=>{s.textContent="";s.classList.remove("saved","error")},3e3)};container.addEventListener("click",async e=>{const target=e.target;if(!(target instanceof HTMLInputElement)||target.type!=="checkbox")return;if(isKanbanCheckbox(target)){console.log("tasklist-live.js: Skipping kanban checkbox, handled by kanban-tasks.js");return}e.preventDefault();const li=target.closest("li");if(!li)return;toggleAll(true);try{const srcResp=await fetch(`/api/source/${docPath}`);if(!srcResp.ok)throw new Error("source fetch failed");const markdown=await srcResp.text();const lines=markdown.split(/\r?\n/);const desiredChecked=!target.checked;const cbIndex=Number(target.dataset.cbIndex);let currentIdx=-1;const updatedLines=lines.map(line=>{const match=line.match(/^(\s*[-*+]\s+)\[(.| )\]\s+(.*)$/);if(!match)return line;currentIdx+=1;if(currentIdx===cbIndex){const[,prefix,,restText]=match;const newMark=desiredChecked?"x":" ";return`${prefix}[${newMark}] ${restText}`}return line});if(cbIndex>currentIdx)throw new Error("checkbox index exceeds markdown task list count");const saveResp=await fetch(`/api/save/${docPath}`,{method:"POST",headers:{"Content-Type":"text/markdown"},body:updatedLines.join("\n")});if(!saveResp.ok)throw new Error("save failed");target.checked=desiredChecked}catch(err){console.error(err);showState(li,"error","error")}finally{toggleAll(false)}})})})();